# ==========================================
# DATA MANIPULATION QUERIES
# ==========================================
data_manipulation:

  # -----------------------
  # USERS
  # -----------------------
  users:

    # ðŸ”¹ Read operations
    get_all: |
      SELECT * FROM users;

    get_by_id: |
      SELECT * FROM users WHERE user_id = :id;

    # Fetch user data for login
    get_by_username: |
      SELECT 
        u.user_id, 
        p.username, 
        p.email, 
        p.password_hash, 
        u.role
      FROM users u
      JOIN pii p ON u.pii_id = p.pii_id
      WHERE p.username = :username;

    # Check for duplicate username
    check_duplicate_username: |
      SELECT COUNT(*) AS total
      FROM pii
      WHERE username = :username;

    # ðŸ”¹ Create operations
    create_pii: |
      INSERT INTO pii (username, email, password_hash, created_at)
      VALUES (:username, :email, :password_hash, CURRENT_TIMESTAMP)

    create_user: |
      INSERT INTO users (pii_id, role, created_at)
      VALUES (:pii_id, 'player', CURRENT_TIMESTAMP)

    # ðŸ”¹ Delete operation
    delete: |
      DELETE FROM users WHERE user_id = :id;


  # -----------------------
  # GAME SESSIONS
  # -----------------------
  game_sessions:

    # ðŸ”¹ Create
    create: |
      INSERT INTO game_sessions (host_id, players, turn, game_prize, game_state, winner)
      VALUES (:host_id, :players, :turn, :game_prize, :game_state, NULL);

    # ðŸ”¹ Read
    get_all: |
      SELECT * FROM game_sessions;

    get_by_id: |
      SELECT * FROM game_sessions WHERE session_id = :id;

    # ðŸ”¹ Update
    update_state: |
      UPDATE game_sessions 
      SET game_state = :game_state, turn = :turn, updated_at = CURRENT_TIMESTAMP
      WHERE session_id = :id;

    end_session: |
      UPDATE game_sessions 
      SET winner = :winner, updated_at = CURRENT_TIMESTAMP
      WHERE session_id = :id;

    # ðŸ”¹ Delete
    delete: |
      DELETE FROM game_sessions WHERE session_id = :id;

    # -----------------------
    # MULTIPLAYER QUERIES
    # -----------------------
    # ðŸ”¹ Create a pending (waiting) session
    create_pending_session: |
      INSERT INTO game_sessions 
      (host_id, players, is_active, grace_until, min_players, created_at, updated_at)
      VALUES (
        :host_id,
        JSON_ARRAY(CAST(:host_id AS UNSIGNED)),
        0,
        DATE_ADD(NOW(), INTERVAL :grace_seconds SECOND),
        :min_players,
        NOW(),
        NOW()
      );


    # ðŸ”¹ Find an open session that is still waiting for another player
    find_open_session: |
      SELECT session_id, host_id, players, is_active, grace_until, min_players
      FROM game_sessions
      WHERE is_active = 0
        AND JSON_LENGTH(players) = 1
        AND grace_until > NOW()
      ORDER BY created_at ASC
      LIMIT 1;

    # ðŸ”¹ Add a second player to a waiting session
    add_player_to_session: |
      UPDATE game_sessions
      SET players = JSON_ARRAY_APPEND(players, '$', :user_id),
          updated_at = NOW()
      WHERE session_id = :id;

    # ðŸ”¹ Activate a session once full (optional)
    activate_session: |
      UPDATE game_sessions
      SET is_active = 1,
          updated_at = NOW()
      WHERE session_id = :id;

   # ðŸ”¹ Expire session when timeout
    expire_session: |
      UPDATE game_sessions
      SET is_active = 0,
          updated_at = NOW()
      WHERE session_id = :id;

    get_session_state: |
      SELECT * FROM game_sessions
      WHERE session_id = :id;


# ==========================================
# TABLE MANIPULATION QUERIES
# ==========================================
table_manipulation:

  # -----------------------
  # GAME SESSIONS TABLE
  # -----------------------
  game_sessions:

    # âœ… Add missing winner column (if not exists)
    add_winner_column: |
      ALTER TABLE game_sessions
      ADD COLUMN winner VARCHAR(32) DEFAULT NULL AFTER game_state;
